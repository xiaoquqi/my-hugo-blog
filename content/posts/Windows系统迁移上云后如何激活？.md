---
title: Windows系统迁移上云后如何激活？
author: 孙琦(Ray)
date: 2021-11-19 08:06:32
tags:
---
使用整机迁移方式(Re-Host)将Windows迁移至云平台后，由于底层的硬件发生改变，导致Windows序列号失效，需要重新进行激活。对于企业用户，如何保护既有投资，使用合理的方式对系统激活而不产生额外费用呢？本文基于项目中的最佳实践，为您详细进行解读。

<!-- more -->

## 为什么迁移后授权失效？

根据微软的解释：在安装Windows时，数字许可证本身与设备的硬件相关联。如果你对设备进行重大的硬件更改（例如更换母板），Windows将无法找到与设备匹配的许可证，因此你需要重新激活Windows才能使其正常运行。

根据云原生迁移工具HyperMotion的迁移原理，基于底层块级别技术进行复制，在系统拉起后，底层硬件变更为云平台的虚拟设备，导致硬件变更，造成了授权失效的情况发生。同时，由于云平台的机制，这种改变是必须的，所以并没有方法从虚拟化底层避免这一问题的发生。所以在公有云和私有云迁移或容灾时，就需要使用不同方法加以应对。

## 公有云

根据目前的公开文档，绝大多数的公有云使用KMS方式对Windows采用自动化激活的方式。

![upload successful](/images/pasted-280.png)

也可以在开机通过设定脚本的方式，实现自动化激活。

```
cscript /nologo %windir%/system32/slmgr.vbs -skms kms.tencentyun.com:1688
cscript /nologo %windir%/system32/slmgr.vbs -ato
```

华为云也是类似的方法，都是通过云内部的KMS实现批量激活。

![upload successful](/images/pasted-281.png)

### 保留原有授权

这种方法目前只在AWS相关文档看到，这个方式叫做License Mobility，但是需要联系到原有授权的经销商才可以提交相关申请。

![upload successful](/images/pasted-282.png)

## 私有云

私有云的客户大多数为企业客户，一般都会购买过正版批量授权，对于授权的可激活次数是有一定宽松条件的。需要明确的一个先决条件，企业用户必须购买了正版的批量授权，零售版不在我们讨论范围内。

首先先要明确一个概念，授权和可激活次数是两个完全不同的概念，授权的数量是一定的，而激活次数是灵活的。也正是利用这一点，可以解决我们在业务系统迁移后，授权激活的问题。解决问题的思路如下：

* 假如用户一共购买了10套Windows Server，那么在Windows批量授权中心，用户可激活的次数应该为50次
* 用户已经安装了10套Windows Server，并且已经激活，此时用户需要进行迁移
* 利用HyperMotion的热迁移能力，在保证业务连续性的前提下，将Windows从VMware环境以无代理方式迁移至了云平台上
* 用户希望利用HyperMotion的迁移验证功能，快速建立仿真环境，我们将10台Windows全部在云平台进行启动（原业务正常运行）
* 此时启动的Windows由于虚拟化底层发生改变，Windows都是未激活状态（Windows 2012如果在联网状况下，会自动尝试激活），但是并不影响业务系统验证
* 客户在验证后，确认业务可用，准备进行系统割接
* 经过最终的增量同步，原有业务系统关机，在正式的VPC内启动业务系统，并保持IP地址不变
* 业务系统割接后，Windows仍然属于未激活状态，我们在联网状态下，使用原有的序列号再次进行激活
* 完成业务系统迁移，同时Windows激活

如果激活次数达到上限后，该如何处理呢？通过咨询微软400，对于企业用户的批量授权，激活次数是可以免费扩充的，只需要在该链接（https://support.microsoft.com/en-us/supportrequestform/2afa6f15-b710-db46-909a-8346017c802f?sl=en&sc=US） 提交申请，大概在5个工作日左右微软完成核实后，用户可以登陆自身的“微软的批量许可中心”查询可激活的次数，或者直接通过400电话咨询想过扩充方式。但是前提是您的激活次数达到上限才可以。

![upload successful](/images/pasted-283.png)

整体的流程请见下图：

![upload successful](/images/pasted-284.png)

## Windows不激活会自动重启吗？

根据微软400电话反馈，由于正版保护的策略，Windows会出现一些随机事件，重启只是其中的一种，但并不是100%出现，目前肯定出现的问题是定期出现的是激活提醒。

## 总结

* 公有云环境，推荐使用公有云自身提供的KMS服务
* 私有云环境，如果你购买了企业的批量授权，并不用担心授权激活问题，微软会帮你解决激活问题